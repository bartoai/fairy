<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat with Bonkara</title>
    <link rel="icon" type="image/png" href="https://cdn.prod.website-files.com/6740d85c4e3daeef29a89470/6887e196a6ca43c1525219f5_ChatGPT%20Image%20Jul%2028%2C%202025%2C%2009_46_08%20PM.png">
    <link rel="shortcut icon" type="image/png" href="https://cdn.prod.website-files.com/6740d85c4e3daeef29a89470/6887e196a6ca43c1525219f5_ChatGPT%20Image%20Jul%2028%2C%202025%2C%2009_46_08%20PM.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier Prime', monospace;
            height: 100vh;
            overflow: hidden;
            background: #000;
            position: relative;
        }

        /* Loading Screen Styles */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a0033 0%, #330066 50%, #1a0033 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 1;
            transition: opacity 1s ease;
        }

        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .bonkara-logo {
            width: 400px;
            height: auto;
            margin-bottom: 30px;
            animation: logoGlow 2s ease-in-out infinite alternate;
        }

        @keyframes logoGlow {
            from { filter: drop-shadow(0 0 10px #ff00ff); }
            to { filter: drop-shadow(0 0 30px #ff00ff); }
        }

        .floating-image {
            width: 300px;
            height: 300px;
            border-radius: 20px;
            margin-bottom: 40px;
            animation: float 3s ease-in-out infinite;
            box-shadow: 0 0 50px rgba(255, 0, 255, 0.3);
            transition: transform 0.3s ease;
        }

        .floating-image:hover {
            transform: scale(1.05);
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }

        .enter-button {
            background: linear-gradient(45deg, #ff0066, #ff3399);
            border: 2px solid #ff00ff;
            color: white;
            font-family: 'Courier Prime', monospace;
            font-size: 18px;
            font-weight: bold;
            padding: 15px 40px;
            border-radius: 15px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 2px;
            transition: all 0.3s ease;
            box-shadow: 0 0 30px rgba(255, 0, 255, 0.5);
            animation: buttonPulse 2s ease-in-out infinite;
        }

        .enter-button:hover {
            background: linear-gradient(45deg, #ff3399, #ff66cc);
            transform: translateY(-3px);
            box-shadow: 0 10px 40px rgba(255, 0, 255, 0.7);
        }

        @keyframes buttonPulse {
            0%, 100% { box-shadow: 0 0 30px rgba(255, 0, 255, 0.5); }
            50% { box-shadow: 0 0 50px rgba(255, 0, 255, 0.8); }
        }

        .warning-text {
            color: #ff6666;
            font-size: 14px;
            margin-top: 20px;
            text-align: center;
            opacity: 0.8;
            letter-spacing: 1px;
        }

        /* Main content hidden initially */
        .main-content {
            opacity: 0;
            transition: opacity 1s ease;
        }

        .main-content.visible {
            opacity: 1;
        }

        /* Background image container */
        .background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('https://cdn.prod.website-files.com/6740d85c4e3daeef29a89470/6887cb12ef6fe7c6ece80324_anime-bedroom-uidy4uvprhbhg84q.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            z-index: 1;
        }

        /* Social media icons */
        .social-icons {
            position: absolute;
            top: 20px;
            z-index: 10;
        }

        .social-icons.left {
            left: 20px;
        }

        .social-icons.right {
            right: 20px;
        }

        .social-icon {
            width: 80px;
            height: 80px;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #333;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #00ff00;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        .social-icon.twitter {
            background-image: url('https://cdn.prod.website-files.com/6740d85c4e3daeef29a89470/688401711f7c1c43849d13a6_HIMACZhOn7YJ71dTu-actor-2fSSfmZramPBO73OK-iBihnF3pbp-dexpng%20(2).png');
        }

        .social-icon.bonk {
            background-image: url('https://cdn.prod.website-files.com/6740d85c4e3daeef29a89470/68433c066e047e6e44c898da_1ed8c36b-4a8e-6394-9e58-9a8c204e7b9e.png');
            background-size: 85%; /* Made the bonk logo slightly smaller */
        }

        .social-icon:hover {
            background: rgba(0, 50, 0, 0.9);
            border-color: #00ff00;
            transform: scale(1.05);
        }

        /* Character model container */
        .character-container {
            position: absolute;
            bottom: 220px; /* Adjusted for new text box positioning */
            left: 50%;
            transform: translateX(-50%);
            width: 1700px; /* Made extra wide to show full wings */
            height: 700px; /* Made taller */
            z-index: 5;
        }

        .character-canvas {
            width: 100%;
            height: 100%;
        }

        .character-loading {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
            text-align: center;
            flex-direction: column;
            gap: 10px;
        }

        /* Text box container */
        .text-box {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 1200px;
            height: 180px;
            background: rgba(0, 0, 0, 0.95);
            border: 2px solid #333;
            border-radius: 8px;
            z-index: 10;
            padding: 20px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.7);
        }

        .character-name {
            color: #00ff00;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .dialogue-text {
            color: #ffffff;
            font-size: 14px;
            line-height: 1.6;
            flex: 1;
            overflow-y: auto;
            margin-bottom: 15px;
            padding-right: 10px;
        }

        .dialogue-text::-webkit-scrollbar {
            width: 6px;
        }

        .dialogue-text::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        .dialogue-text::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 3px;
        }

        .dialogue-text::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .message {
            margin-bottom: 15px;
            padding: 8px 0;
        }

        .message.user {
            color: #ffff00;
        }

        .message.user::before {
            content: "> ";
            color: #00ff00;
        }

        .message.fairy {
            color: #ffffff;
            position: relative;
        }

        .voice-button {
            position: absolute;
            right: 10px;
            top: 8px;
            background: transparent;
            border: 1px solid #00ff00;
            color: #00ff00;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
            border-radius: 4px;
            font-family: 'Courier Prime', monospace;
            transition: all 0.3s ease;
        }

        .voice-button:hover:not(:disabled) {
            background: rgba(0, 255, 0, 0.1);
        }

        .voice-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .voice-button.playing {
            background: rgba(0, 255, 0, 0.2);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }

        .typing-indicator {
            color: #00ff00;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        .input-container {
            display: flex;
            align-items: center;
            gap: 10px;
            border-top: 1px solid #333;
            padding-top: 15px;
        }

        .input-prompt {
            color: #00ff00;
            font-size: 14px;
            white-space: nowrap;
        }

        .message-input {
            flex: 1;
            background: transparent;
            border: none;
            color: #ffffff;
            font-family: 'Courier Prime', monospace;
            font-size: 14px;
            outline: none;
            padding: 2px;
            border-bottom: 1px solid #333;
        }

        .message-input:focus {
            border-bottom-color: #00ff00;
        }

        .send-button {
            background: transparent;
            border: 1px solid #333;
            color: #00ff00;
            padding: 6px 12px;
            font-family: 'Courier Prime', monospace;
            font-size: 12px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
        }

        .send-button:hover:not(:disabled) {
            background: rgba(0, 255, 0, 0.1);
            border-color: #00ff00;
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .loading-dots {
            display: inline-block;
        }

        .loading-dots::after {
            content: '';
            animation: dots 1.5s infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .character-container {
                width: 400px; /* Smaller on mobile */
                height: 500px;
                bottom: 240px; /* Adjust for bigger text box on mobile */
            }

            .text-box {
                height: 220px;
                padding: 15px;
            }

            .social-icon {
                width: 60px;
                height: 60px;
                font-size: 10px;
            }

            .social-icons {
                top: 10px;
            }

            .social-icons.left {
                left: 10px;
            }

            .social-icons.right {
                right: 10px;
            }

            .dialogue-text {
                font-size: 13px;
            }

            .message-input {
                font-size: 13px;
            }
        }
    </style>
</head>
<body>
    <!-- Background -->
    <div class="background"></div>

    <!-- Social Media Icons -->
    <div class="social-icons left">
        <div class="social-icon twitter" onclick="window.open('https://twitter.com', '_blank')">
        </div>
    </div>

    <div class="social-icons right">
        <div class="social-icon bonk" onclick="window.open('#', '_blank')">
        </div>
    </div>

    <!-- Character Model -->
    <div class="character-container">
        <canvas id="characterCanvas" class="character-canvas"></canvas>
        <div id="characterLoading" class="character-loading">
            <div>Loading Luna...</div>
            <div class="loading-dots"></div>
        </div>
    </div>

    <!-- Text Box -->
    <div class="text-box">
        <div class="character-name">Bonkara</div>
        <div class="dialogue-text" id="dialogueText">
            <div class="message fairy">
                Welcome to my magical realm! I'm Bonkara, and I've been waiting for someone like you to visit. 
                The forest spirits whisper that you have questions burning in your heart. What brings you to my domain today?
            </div>
        </div>
        <div class="input-container">
            <span class="input-prompt">></span>
            <input type="text" class="message-input" id="messageInput" placeholder="Type your message..." maxlength="500">
            <button class="send-button" id="sendButton" onclick="sendMessage()">Send</button>
        </div>
    </div>

    <script>
        // Three.js setup for character model
        let scene, camera, renderer, fairy, mixer;
        const canvas = document.getElementById('characterCanvas');
        const loadingDiv = document.getElementById('characterLoading');

        function initThreeJS() {
            // Scene setup
            scene = new THREE.Scene();

            // Camera setup for visual novel style
            camera = new THREE.PerspectiveCamera(45, canvas.clientWidth / canvas.clientHeight, 0.1, 1000);
            camera.position.set(0, 1.5, 2.2); // Moved camera up to show face
            camera.lookAt(0, 1.2, 0); // Looking at upper body area

            // Renderer setup
            renderer = new THREE.WebGLRenderer({ 
                canvas: canvas, 
                antialias: true, 
                alpha: true 
            });
            renderer.setSize(canvas.clientWidth, canvas.clientHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;

            // Lighting setup for character
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
            scene.add(ambientLight);

            const keyLight = new THREE.DirectionalLight(0xffffff, 1.2);
            keyLight.position.set(2, 3, 2);
            keyLight.castShadow = true;
            scene.add(keyLight);

            const fillLight = new THREE.DirectionalLight(0xa8c8ff, 0.6);
            fillLight.position.set(-2, 1, 1);
            scene.add(fillLight);

            // Load the fairy model
            loadFairyModel();
        }

        function loadFairyModel() {
            const loader = new THREE.GLTFLoader();
            // Using jsdelivr CDN which supports CORS for GitHub files
            const modelUrl = 'https://cdn.jsdelivr.net/gh/bartoai/fairy@main/fairywoman.glb';
            
            loader.load(
                modelUrl,
                function(gltf) {
                    fairy = gltf.scene;
                    
                    // Scale and position for visual novel style
                    fairy.scale.set(2.0, 2.0, 2.0); // Made her a bit smaller
                    fairy.position.set(0, -2.7, 0); // Adjusted position to 2.7
                    
                    // Enable shadows
                    fairy.traverse(function(child) {
                        if (child.isMesh) {
                            child.castShadow = true;
                            child.receiveShadow = true;
                        }
                    });
                    
                    scene.add(fairy);
                    
                    // Hide loading and show model
                    loadingDiv.style.display = 'none';
                    canvas.style.display = 'block';
                    
                    // Setup animations
                    if (gltf.animations && gltf.animations.length > 0) {
                        mixer = new THREE.AnimationMixer(fairy);
                        const action = mixer.clipAction(gltf.animations[0]);
                        action.play();
                    }
                    
                    animate();
                },
                function(progress) {
                    console.log('Loading progress:', (progress.loaded / progress.total * 100) + '%');
                },
                function(error) {
                    console.error('Error loading model:', error);
                    loadingDiv.innerHTML = `
                        <div>Failed to load model</div>
                        <div style="font-size: 12px; margin-top: 5px;">
                            Check if fairywoman.glb exists in repo
                        </div>
                    `;
                }
            );
        }

        function animate() {
            requestAnimationFrame(animate);
            
            if (mixer) {
                mixer.update(0.008); // Slowed down animation (was 0.016)
            }
            
            // Subtle breathing animation if no animations
            if (fairy && !mixer) {
                fairy.position.y = Math.sin(Date.now() * 0.001) * 0.02;
            }
            
            renderer.render(scene, camera);
        }

        // Handle window resize
        function onWindowResize() {
            const container = canvas.parentElement;
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        }

        window.addEventListener('resize', onWindowResize);

        // Don't initialize Three.js on load anymore - wait for user interaction
        // window.addEventListener('load', initThreeJS);

        // Chat functionality
        const dialogueText = document.getElementById('dialogueText');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');

        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;

            // Add user message
            addMessage(message, 'user');
            messageInput.value = '';
            sendButton.disabled = true;
            sendButton.innerHTML = 'Sending<span class="loading-dots"></span>';

            try {
                // Simulate API call - replace with actual Anthropic API
                await simulateAPICall(message);
            } catch (error) {
                addMessage("*The fairy's magic flickers* Something went wrong... please try again!", 'fairy');
            }

            sendButton.disabled = false;
            sendButton.innerHTML = 'Send';
        }

        function addMessage(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            if (sender === 'fairy') {
                // Add voice button for fairy messages
                const voiceButton = document.createElement('button');
                voiceButton.className = 'voice-button';
                voiceButton.textContent = '🔊';
                voiceButton.onclick = () => playVoice(text, voiceButton);
                messageDiv.appendChild(voiceButton);
                
                // Add typing effect for fairy messages
                dialogueText.appendChild(messageDiv);
                typeMessage(messageDiv, text);
            } else {
                // User messages appear immediately
                messageDiv.textContent = text;
                dialogueText.appendChild(messageDiv);
            }
            
            dialogueText.scrollTop = dialogueText.scrollHeight;
        }

        /* Auto-play functionality */
        let audioAutoPlay = false;

        async function playVoiceAuto(text) {
            if (!audioAutoPlay) return;
            
            try {
                const response = await fetch('/api/tts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ text: text })
                });

                if (response.ok) {
                    const data = await response.json();
                    const audio = new Audio();
                    audio.src = `data:audio/mpeg;base64,${data.audio}`;
                    audio.play().catch(e => console.log('Auto-play failed:', e));
                }
            } catch (error) {
                console.log('Auto-play TTS failed:', error);
            }
        }
            if (button.disabled) return;
            
            button.disabled = true;
            button.classList.add('playing');
            button.textContent = '⏸️';
            
            try {
                const response = await fetch('/api/tts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ text: text })
                });

                if (!response.ok) {
                    throw new Error('TTS request failed');
                }

                const data = await response.json();
                
                // Create audio element and play
                const audio = new Audio();
                audio.src = `data:audio/mpeg;base64,${data.audio}`;
                
                audio.onended = () => {
                    button.disabled = false;
                    button.classList.remove('playing');
                    button.textContent = '🔊';
                };
                
                audio.onerror = () => {
                    button.disabled = false;
                    button.classList.remove('playing');
                    button.textContent = '🔊';
                    console.error('Audio playback failed');
                };
                
                await audio.play();
                
            } catch (error) {
                console.error('Voice generation failed:', error);
                button.disabled = false;
                button.classList.remove('playing');
                button.textContent = '🔊';
            }
        }

        function typeMessage(element, text, speed = 30) {
            let i = 0;
            element.textContent = '';
            
            function typeChar() {
                if (i < text.length) {
                    element.textContent += text.charAt(i);
                    i++;
                    dialogueText.scrollTop = dialogueText.scrollHeight;
                    setTimeout(typeChar, speed);
                }
            }
            
            typeChar();
        }

        // Simulate API response (replace with actual Anthropic integration)
        async function simulateAPICall(userMessage) {
            // Replace this with actual API call
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: userMessage,
                        character: 'bonkara'
                    })
                });

                if (!response.ok) {
                    throw new Error('API request failed');
                }

                const data = await response.json();
                addMessage(data.response, 'fairy');
            } catch (error) {
                console.error('API Error:', error);
                // Fallback responses
                const fallbackResponses = [
                    "How fascinating! The ancient trees have been whispering about visitors like you. There's something special about your energy that draws the forest spirits near.",
                    "That question carries the scent of adventure! In my realm, such thoughts bloom into magical possibilities. I can sense great potential within you.",
                    "Oh my! You remind me of the wise spirits who dwell beyond the crystal caves. Your curiosity sparkles brighter than starlight.",
                    "The moonlight reveals that you seek something deeper than words can express. I can feel the longing in your heart, dear visitor.",
                    "Your energy resonates with the harmony of the enchanted grove. Tell me more about what brings you to my mystical domain, wanderer."
                ];
                
                const randomResponse = fallbackResponses[Math.floor(Math.random() * fallbackResponses.length)];
                addMessage(randomResponse, 'fairy');
            }
        }

        // TODO: Replace with actual Anthropic API integration
        /*
        async function callAnthropicAPI(message) {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: message,
                    character: 'fairy',
                    style: 'mystical'
                })
            });
            
            const data = await response.json();
            return data.response;
        }
        */
    </script>
</body>
</html>
