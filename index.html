<body>
    <!-- Loading Screen - Grok Style -->
    <div id="loadingScreen" class="loading-screen">
        <div class="grok-header">
            <div class="grok-title">GROK COMPANION</div>
            <div class="grok-subtitle">Advanced AI Testing Interface</div>
        </div>

        <div class="floating-windows-container">
            <div class="floating-window window-1">
                <img src="https://cdn.prod.website-files.com/6740d85c4e3daeef29a89470/6887e196a6ca43c1525219f5_ChatGPT%20Image%20Jul%2028%2C%202025%2C%2009_46_08%20PM.png" 
                     alt="Bonkara" class="window-image">
                <div class="window-name">BONKARA</div>
                <div class="window-status">Neural Network Active</div>
            </div>

            <div class="floating-window window-2">
                <img src="https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=200&h=150&fit=crop" 
                     alt="Luna" class="window-image">
                <div class="window-name">LUNA</div>
                <div class="window-status">Offline</div>
            </div>

            <div class="floating-window window-3">
                <img src="https://images.unsplash.com/photo-1544005313-94ddf0286df2?w=200&h=150&fit=crop" 
                     alt="Aria" class="window-image">
                <div class="window-name">ARIA</div>
                <div class="window-status">Standby Mode</div>
            </div>

            <div class="floating-window window-4">
                <img src="https://images.unsplash.com/photo-1494790108755-2616c9c75b5d?w=200&h=150&fit=crop" 
                     alt="Nova" class="window-image">
                <div class="window-name">NOVA</div>
                <div class="window-status">Maintenance</div>
            </div>
        </div>

        <button class="access-button" onclick="enterSite()">
            ACCESS BONKARA
        </button>
        
        <div class="grok-warning">
            Experimental AI • Adult Content • Proceed with Caution
        </div>
    </div>

    <!-- Main Content -->
    <div id="mainContent" class="main-content">
        <!-- Memory Indicator -->
        <div id="memoryIndicator" class="memory-indicator">
            Bonkara remembers you! ✨
        </div>

        <!-- Background Toggle Button -->
        <button class="bg-toggle-btn" onclick="toggleBackgroundSelector()" title="Change Background">
        </button>

        <!-- Background Selector -->
        <div id="backgroundSelector" class="background-selector">
            <div class="bg-selector-title">Choose Background</div>
            <div class="background-option active" data-bg="default" data-name="Bedroom" 
                 style="background-image: url('https://cdn.prod.website-files.com/6740d85c4e3daeef29a89470/6887cb12ef6fe7c6ece80324_anime-bedroom-uidy4uvprhbhg84q.jpg')"
                 onclick="setBackground('default')"></div>
            <div class="background-option" data-bg="gym" data-name="Gym"
                 style="background-image: url('https://cdn.prod.website-files.com/6740d85c4e3daeef29a89470/6887f8d1a34ef0893b9b7841_3d179b3d1e4dd193869406730925be71.jpg')"
                 onclick="setBackground('gym')"></div>
            <div class="background-option" data-bg="future" data-name="Future Bonk"
                 style="background-image: url('https://cdn.prod.website-files.com/6740d85c4e3daeef29a89470/6887f8d150076a190352ea5d_1e993a515f75ec9addd4c36eb6a74640%20(1)%20(1).png')"
                 onclick="setBackground('future')"></div>
            <div class="background-option" data-bg="streets" data-name="The Streets"
                 style="background-image: url('https://cdn.prod.website-files.com/6740d85c4e3daeef29a89470/6887f8fbcbc040107d95c8c3_bnef3fhuqm261%20(2).png')"
                 onclick="setBackground('streets')"></div>
            <div class="background-option" data-bg="bonk" data-name="Bonk"
                 style="background-image: url('https://cdn.prod.website-files.com/6740d85c4e3daeef29a89470/6887f9169ce3ce8776ce421c_51lJBZ66FTL.jpg')"
                 onclick="setBackground('bonk')"></div>
        </div>

        <!-- Background -->
        <div class="background"></div>

        <!-- Social Media Icons -->
        <div class="social-icons left">
            <div class="social-icon twitter" onclick="window.open('https://twitter.com', '_blank')">
            </div>
            <div class="social-icon bonk" onclick="window.open('#', '_blank')">
            </div>
            <div class="social-icon onlyfans" onclick="window.open('https://onlyfans.com', '_blank')">
            </div>
        </div>

        <div class="social-icons right">
        </div>

        <!-- Character Model -->
        <div class="character-container">
            <canvas id="characterCanvas" class="character-canvas"></canvas>
            <div id="characterLoading" class="character-loading">
                <div>Loading Bonkara...</div>
                <div class="loading-dots"></div>
            </div>
        </div>

        <!-- Text Box -->
        <div class="text-box">
            <div class="character-name">Bonkara</div>
            <div class="dialogue-text" id="dialogueText">
                <div class="message fairy">
                    Welcome to my magical realm! I'm Bonkara, and I've been waiting for someone like you to visit. 
                    The forest spirits whisper that you have questions burning in your heart. What brings you to my domain today?
                </div>
            </div>
            <div class="input-container">
                <span class="input-prompt">></span>
                <input type="text" class="message-input" id="messageInput" placeholder="Type your message..." maxlength="500">
                <button class="mic-button" id="micButton" onclick="toggleSpeechRecognition()" title="Click to speak"></button>
                <button class="send-button" id="sendButton" onclick="sendMessage()">Send</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables - Fixed scope
        let scene, camera, renderer, fairy, mixer;
        let audioAutoPlay = false;
        let backgroundMusic = null;
        let messageReactions = new Map();
        let messageCounter = 0;
        let speechRecognition = null;
        let isRecording = false;
        let userMemory = {};
        let currentBackground = 'default';
        
        // Load saved data
        try {
            userMemory = JSON.parse(localStorage.getItem('bonkara_memory') || '{}');
            currentBackground = localStorage.getItem('bonkara_background') || 'default';
        } catch (e) {
            userMemory = {};
            currentBackground = 'default';
        }

        // Available backgrounds - Updated with custom backgrounds
        const backgrounds = {
            default: 'https://cdn.prod.website-files.com/6740d85c4e3daeef29a89470/6887cb12ef6fe7c6ece80324_anime-bedroom-uidy4uvprhbhg84q.jpg',
            gym: 'https://cdn.prod.website-files.com/6740d85c4e3daeef29a89470/6887f8d1a34ef0893b9b7841_3d179b3d1e4dd193869406730925be71.jpg',
            future: 'https://cdn.prod.website-files.com/6740d85c4e3daeef29a89470/6887f8d150076a190352ea5d_1e993a515f75ec9addd4c36eb6a74640%20(1)%20(1).png',
            streets: 'https://cdn.prod.website-files.com/6740d85c4e3daeef29a89470/6887f8fbcbc040107d95c8c3_bnef3fhuqm261%20(2).png',
            bonk: 'https://cdn.prod.website-files.com/6740d85c4e3daeef29a89470/6887f9169ce3ce8776ce421c_51lJBZ66FTL.jpg'
        };

        const canvas = document.getElementById('characterCanvas');
        const loadingDiv = document.getElementById('characterLoading');
        const dialogueText = document.getElementById('dialogueText');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const micButton = document.getElementById('micButton');

        // Sound effects
        const soundEffects = {
            messageSend: null,
            messageReceived: null,
            reaction: null
        };

        // Initialize sound effects
        function initSoundEffects() {
            soundEffects.messageSend = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmESBjuR2O/TeSsFJHfH8N2QQAoUXrTp66hVFA==');
            soundEffects.messageReceived = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmESBjuR2O/TeSsFJHfH8N2QQAoUXrTp66hVFA==');
            soundEffects.reaction = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmESBjuR2O/TeSsFJHfH8N2QQAoUXrTp66hVFA==');
            
            Object.values(soundEffects).forEach(sound => {
                if (sound) sound.volume = 0.3;
            });
        }

        function playSound(soundName) {
            if (soundEffects[soundName]) {
                soundEffects[soundName].currentTime = 0;
                soundEffects[soundName].play().catch(e => console.log('Sound play failed:', e));
            }
        }

        // Enter site function
        function enterSite() {
            audioAutoPlay = true;
            
            const loadingScreen = document.getElementById('loadingScreen');
            const mainContent = document.getElementById('mainContent');
            
            loadingScreen.classList.add('hidden');
            mainContent.classList.add('visible');
            
            setBackground(currentBackground);
            
            if (Object.keys(userMemory).length > 0) {
                showMemoryIndicator();
            }
            
            startBackgroundMusic();
            initSoundEffects();
            initSpeechRecognition();
            initThreeJS();
        }

        // Memory functions
        function updateUserMemory(key, value) {
            userMemory[key] = value;
            localStorage.setItem('bonkara_memory', JSON.stringify(userMemory));
        }

        function getUserMemory() {
            return userMemory;
        }

        function showMemoryIndicator() {
            const indicator = document.getElementById('memoryIndicator');
            indicator.classList.add('show');
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 3000);
        }

        // Background functions
        function toggleBackgroundSelector() {
            const selector = document.getElementById('backgroundSelector');
            selector.classList.toggle('open');
        }

        function setBackground(bgKey) {
            currentBackground = bgKey;
            const backgroundDiv = document.querySelector('.background');
            backgroundDiv.style.backgroundImage = `url('${backgrounds[bgKey]}')`;
            localStorage.setItem('bonkara_background', bgKey);
            
            document.querySelectorAll('.background-option').forEach(option => {
                option.classList.remove('active');
            });
            document.querySelector(`[data-bg="${bgKey}"]`)?.classList.add('active');
        }

        // Background music function
        function startBackgroundMusic() {
            try {
                backgroundMusic = new Audio('https://cdn.jsdelivr.net/gh/bartoai/fairy@main/background-music.mp3');
                backgroundMusic.loop = true;
                backgroundMusic.volume = 0.1;
                
                backgroundMusic.play().catch(error => {
                    console.log('Background music autoplay blocked:', error);
                    createMusicToggle();
                });
            } catch (error) {
                console.log('Background music failed to load:', error);
            }
        }

        function createMusicToggle() {
            const musicButton = document.createElement('button');
            musicButton.innerHTML = '🎵';
            musicButton.style.cssText = `
                position: fixed;
                top: 20px;
                right: 120px;
                z-index: 15;
                background: rgba(0, 0, 0, 0.8);
                border: 1px solid #00ff00;
                color: #00ff00;
                padding: 8px 12px;
                border-radius: 5px;
                cursor: pointer;
                font-size: 16px;
            `;
            
            let musicPlaying = false;
            musicButton.onclick = () => {
                if (!musicPlaying) {
                    backgroundMusic.play();
                    musicButton.innerHTML = '🔇';
                    musicPlaying = true;
                } else {
                    backgroundMusic.pause();
                    musicButton.innerHTML = '🎵';
                    musicPlaying = false;
                }
            };
            
            document.body.appendChild(musicButton);
        }

        // Speech recognition setup
        function initSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                speechRecognition = new SpeechRecognition();
                
                speechRecognition.continuous = false;
                speechRecognition.interimResults = false;
                speechRecognition.lang = 'en-US';
                
                speechRecognition.onstart = function() {
                    isRecording = true;
                    micButton.className = 'mic-button recording';
                    micButton.textContent = '🔴';
                };
                
                speechRecognition.onresult = function(event) {
                    const transcript = event.results[0][0].transcript;
                    messageInput.value = transcript;
                };
                
                speechRecognition.onerror = function(event) {
                    console.error('Speech recognition error:', event.error);
                    resetMicButton();
                };
                
                speechRecognition.onend = function() {
                    resetMicButton();
                    if (messageInput.value.trim()) {
                        sendMessage();
                    }
                };
            } else {
                micButton.style.display = 'none';
            }
        }

        function toggleSpeechRecognition() {
            if (!speechRecognition) return;
            
            if (isRecording) {
                speechRecognition.stop();
            } else {
                speechRecognition.start();
            }
        }

        function resetMicButton() {
            isRecording = false;
            micButton.className = 'mic-button';
            micButton.textContent = '';
        }

        // Three.js setup
        function initThreeJS() {
            scene = new THREE.Scene();

            const container = document.querySelector('.character-container');
            const containerWidth = container.clientWidth;
            const containerHeight = container.clientHeight;

            camera = new THREE.PerspectiveCamera(45, containerWidth / containerHeight, 0.1, 1000);
            camera.position.set(0, 1.5, 2.2);
            camera.lookAt(0, 1.2, 0);

            renderer = new THREE.WebGLRenderer({ 
                canvas: canvas, 
                antialias: true, 
                alpha: true 
            });
            
            renderer.setSize(containerWidth, containerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;

            const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
            scene.add(ambientLight);

            const keyLight = new THREE.DirectionalLight(0xffffff, 1.2);
            keyLight.position.set(2, 3, 2);
            keyLight.castShadow = true;
            scene.add(keyLight);

            const fillLight = new THREE.DirectionalLight(0xa8c8ff, 0.6);
            fillLight.position.set(-2, 1, 1);
            scene.add(fillLight);

            setTimeout(() => {
                onWindowResize();
            }, 100);

            loadFairyModel();
        }

        function loadFairyModel() {
            const loader = new THREE.GLTFLoader();
            const modelUrl = 'https://cdn.jsdelivr.net/gh/bartoai/fairy@main/fairywoman.glb';
            
            const manager = new THREE.LoadingManager();
            loader.manager = manager;
            
            loader.load(
                modelUrl,
                function(gltf) {
                    fairy = gltf.scene;
                    
                    fairy.scale.set(2.0, 2.0, 2.0);
                    fairy.position.set(0, -2.7, 0);
                    
                    fairy.traverse(function(child) {
                        if (child.isMesh) {
                            child.castShadow = true;
                            child.receiveShadow = true;
                            if (child.material) {
                                child.material.needsUpdate = true;
                            }
                        }
                    });
                    
                    scene.add(fairy);
                    
                    loadingDiv.style.display = 'none';
                    canvas.style.display = 'block';
                    
                    setTimeout(() => {
                        onWindowResize();
                        renderer.render(scene, camera);
                    }, 50);
                    
                    if (gltf.animations && gltf.animations.length > 0) {
                        mixer = new THREE.AnimationMixer(fairy);
                        const action = mixer.clipAction(gltf.animations[0]);
                        action.play();
                    }
                    
                    animate();
                },
                function(progress) {
                    const percent = Math.round((progress.loaded / progress.total) * 100);
                    loadingDiv.innerHTML = `
                        <div>Loading Bonkara... ${percent}%</div>
                        <div class="loading-dots"></div>
                    `;
                },
                function(error) {
                    console.error('Error loading model:', error);
                    loadingDiv.innerHTML = `
                        <div>Failed to load model</div>
                        <div style="font-size: 12px; margin-top: 5px;">
                            Check connection and try refreshing
                        </div>
                    `;
                }
            );
        }

        function animate() {
            requestAnimationFrame(animate);
            
            if (mixer) {
                mixer.update(0.008);
            }
            
            if (fairy && !mixer) {
                fairy.position.y = Math.sin(Date.now() * 0.001) * 0.02;
            }
            
            renderer.render(scene, camera);
        }

        function onWindowResize() {
            const container = canvas.parentElement;
            const containerWidth = container.clientWidth;
            const containerHeight = container.clientHeight;
            
            if (camera) {
                camera.aspect = containerWidth / containerHeight;
                camera.updateProjectionMatrix();
            }
            
            if (renderer) {
                renderer.setSize(containerWidth, containerHeight);
            }
            
            if (scene && camera && renderer) {
                renderer.render(scene, camera);
            }
        }

        window.addEventListener('resize', onWindowResize);

        // Chat functionality
        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;

            playSound('messageSend');
            addMessage(message, 'user');
            messageInput.value = '';
            sendButton.disabled = true;
            sendButton.innerHTML = 'Sending<span class="loading-dots"></span>';

            showTypingIndicator();

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        character: 'bonkara',
                        userMemory: getUserMemory()
                    })
                });

                if (!response.ok) {
                    throw new Error('API request failed');
                }

                const data = await response.json();
                
                hideTypingIndicator();
                addMessage(data.response, 'fairy');
                playSound('messageReceived');
            } catch (error) {
                console.error('API Error:', error);
                const fallbackResponses = [
                    "How fascinating! The ancient trees have been whispering about visitors like you. There's something special about your energy that draws the forest spirits near.",
                    "That question carries the scent of adventure! In my realm, such thoughts bloom into magical possibilities. I can sense great potential within you.",
                    "Oh my! You remind me of the wise spirits who dwell beyond the crystal caves. Your curiosity sparkles brighter than starlight.",
                    "The moonlight reveals that you seek something deeper than words can express. I can feel the longing in your heart, dear visitor.",
                    "Your energy resonates with the harmony of the enchanted grove. Tell me more about what brings you to my mystical domain, wanderer."
                ];
                
                const randomResponse = fallbackResponses[Math.floor(Math.random() * fallbackResponses.length)];
                hideTypingIndicator();
                addMessage(randomResponse, 'fairy');
                playSound('messageReceived');
            }

            sendButton.disabled = false;
            sendButton.innerHTML = 'Send';
        }

        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing-indicator';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = 'Bonkara is typing<span class="typing-dots">...</span>';
            dialogueText.appendChild(typingDiv);
            dialogueText.scrollTop = dialogueText.scrollHeight;
        }

        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        function addMessage(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            const messageId = ++messageCounter;
            messageDiv.dataset.messageId = messageId;
            
            if (sender === 'fairy') {
                const voiceButton = document.createElement('button');
                voiceButton.className = 'voice-button';
                voiceButton.textContent = '🔊';
                voiceButton.onclick = () => playVoice(text, voiceButton);
                messageDiv.appendChild(voiceButton);
                
                const reactionContainer = document.createElement('div');
                reactionContainer.className = 'reaction-buttons';
                
                const reactions = ['❤️', '😍', '🔥', '😱', '😂'];
                reactions.forEach(emoji => {
                    const reactionBtn = document.createElement('button');
                    reactionBtn.className = 'reaction-btn';
                    reactionBtn.textContent = emoji;
                    reactionBtn.onclick = () => addReaction(messageId, emoji);
                    reactionContainer.appendChild(reactionBtn);
                });
                
                messageDiv.appendChild(reactionContainer);
                
                const reactionsDisplay = document.createElement('div');
                reactionsDisplay.className = 'user-reactions';
                reactionsDisplay.id = `reactions-${messageId}`;
                messageDiv.appendChild(reactionsDisplay);
                
                dialogueText.appendChild(messageDiv);
                
                if (audioAutoPlay) {
                    prepareAndPlayTogether(messageDiv, text);
                } else {
                    typeMessage(messageDiv, text);
                }
            } else {
                messageDiv.textContent = text;
                dialogueText.appendChild(messageDiv);
            }
            
            dialogueText.scrollTop = dialogueText.scrollHeight;
        }

        function addReaction(messageId, emoji) {
            playSound('reaction');
            
            if (!messageReactions.has(messageId)) {
                messageReactions.set(messageId, new Map());
            }
            
            const messageReactionMap = messageReactions.get(messageId);
            const currentCount = messageReactionMap.get(emoji) || 0;
            messageReactionMap.set(emoji, currentCount + 1);
            
            updateReactionsDisplay(messageId);
        }

        function updateReactionsDisplay(messageId) {
            const reactionsDisplay = document.getElementById(`reactions-${messageId}`);
            const messageReactionMap = messageReactions.get(messageId);
            
            if (!reactionsDisplay || !messageReactionMap) return;
            
            let html = '';
            messageReactionMap.forEach((count, emoji) => {
                if (count > 0) {
                    html += `<span class="reaction-count">${emoji} ${count}</span>`;
                }
            });
            
            reactionsDisplay.innerHTML = html;
        }

        function typeMessage(element, text, callback, speed = 30) {
            let i = 0;
            element.textContent = '';
            
            function typeChar() {
                if (i < text.length) {
                    element.textContent += text.charAt(i);
                    i++;
                    dialogueText.scrollTop = dialogueText.scrollHeight;
                    setTimeout(typeChar, speed);
                } else if (callback) {
                    callback();
                }
            }
            
            typeChar();
        }

        async function prepareAndPlayTogether(element, text) {
            try {
                element.textContent = '...';
                
                const response = await fetch('/api/tts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ text: text })
                });

                if (response.ok) {
                    const data = await response.json();
                    const audio = new Audio();
                    audio.src = `data:audio/mpeg;base64,${data.audio}`;
                    
                    audio.play().catch(e => console.log('Auto-play failed:', e));
                    typeMessage(element, text);
                } else {
                    typeMessage(element, text);
                }
            } catch (error) {
                console.log('Audio preparation failed:', error);
                typeMessage(element, text);
            }
        }

        async function playVoice(text, button) {
            if (button.disabled) return;
            
            button.disabled = true;
            button.classList.add('playing');
            button.textContent = '⏸️';
            
            try {
                const response = await fetch('/api/tts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ text: text })
                });

                if (!response.ok) {
                    throw new Error('TTS request failed');
                }

                const data = await response.json();
                
                const audio = new Audio();
                audio.src = `data:audio/mpeg;base64,${data.audio}`;
                
                audio.onended = () => {
                    button.disabled = false;
                    button.classList.remove('playing');
                    button.textContent = '🔊';
                };
                
                audio.onerror = () => {
                    button.disabled = false;
                    button.classList.remove('playing');
                    button.textContent = '🔊';
                    console.error('Audio playback failed');
                };
                
                await audio.play();
                
            } catch (error) {
                console.error('Voice generation failed:', error);
                button.disabled = false;
                button.classList.remove('playing');
                button.textContent = '🔊';
            }
        }
    </script>
</body>
</html>
