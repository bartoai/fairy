<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat with Bonkara</title>
    <link rel="icon" type="image/png" href="https://cdn.prod.website-files.com/6740d85c4e3daeef29a89470/6887e196a6ca43c1525219f5_ChatGPT%20Image%20Jul%2028%2C%202025%2C%2009_46_08%20PM.png">
    <link rel="shortcut icon" type="image/png" href="https://cdn.prod.website-files.com/6740d85c4e3daeef29a89470/6887e196a6ca43c1525219f5_ChatGPT%20Image%20Jul%2028%2C%202025%2C%2009_46_08%20PM.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier Prime', monospace;
            height: 100vh;
            overflow: hidden;
            background: #000;
            position: relative;
        }

        /* Loading Screen Styles */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 1;
            transition: opacity 1s ease;
        }

        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .bonkara-logo {
            width: 400px;
            height: auto;
            margin-bottom: 30px;
        }

        .floating-image {
            width: 300px;
            height: 300px;
            border-radius: 20px;
            margin-bottom: 40px;
            animation: float 3s ease-in-out infinite;
            box-shadow: 0 0 50px rgba(255, 0, 255, 0.3);
            transition: transform 0.3s ease;
        }

        .floating-image:hover {
            transform: scale(1.05);
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }

        .enter-button {
            background: linear-gradient(45deg, #00ff00, #00cc00);
            border: 2px solid #00ff00;
            color: black;
            font-family: 'Courier Prime', monospace;
            font-size: 18px;
            font-weight: bold;
            padding: 15px 40px;
            border-radius: 15px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 2px;
            transition: all 0.3s ease;
            box-shadow: 0 0 30px rgba(0, 255, 0, 0.5);
            animation: buttonPulse 2s ease-in-out infinite;
        }

        .enter-button:hover {
            background: linear-gradient(45deg, #00cc00, #009900);
            transform: translateY(-3px);
            box-shadow: 0 10px 40px rgba(0, 255, 0, 0.7);
        }

        @keyframes buttonPulse {
            0%, 100% { box-shadow: 0 0 30px rgba(0, 255, 0, 0.5); }
            50% { box-shadow: 0 0 50px rgba(0, 255, 0, 0.8); }
        }

        .warning-text {
            color: #ff6666;
            font-size: 14px;
            margin-top: 20px;
            text-align: center;
            opacity: 0.8;
            letter-spacing: 1px;
        }

        /* Main content hidden initially */
        .main-content {
            opacity: 0;
            transition: opacity 1s ease;
        }

        .main-content.visible {
            opacity: 1;
        }

        /* Background image container */
        .background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('https://cdn.prod.website-files.com/6740d85c4e3daeef29a89470/6887cb12ef6fe7c6ece80324_anime-bedroom-uidy4uvprhbhg84q.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            z-index: 1;
        }

        /* Social media icons */
        .social-icons {
            position: absolute;
            top: 20px;
            z-index: 10;
        }

        .social-icons.left {
            left: 20px;
        }

        .social-icons.right {
            right: 20px;
        }

        .social-icon {
            width: 80px;
            height: 80px;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #333;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #00ff00;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        .social-icon.twitter {
            background-image: url('https://cdn.prod.website-files.com/6740d85c4e3daeef29a89470/688401711f7c1c43849d13a6_HIMACZhOn7YJ71dTu-actor-2fSSfmZramPBO73OK-iBihnF3pbp-dexpng%20(2).png');
        }

        .social-icon.bonk {
            background-image: url('https://cdn.prod.website-files.com/6740d85c4e3daeef29a89470/68433c066e047e6e44c898da_1ed8c36b-4a8e-6394-9e58-9a8c204e7b9e.png');
            background-size: 85%;
        }

        .social-icon.onlyfans {
            background-image: url('https://cdn.prod.website-files.com/6740d85c4e3daeef29a89470/6887e9d069c172360a2d3e4c_ChatGPT%20Image%20Jul%2028%2C%202025%2C%2010_21_04%20PM.png');
            background-size: cover;
        }

        .social-icon:hover {
            background-color: rgba(0, 50, 0, 0.9);
            border-color: #00ff00;
            transform: scale(1.05);
        }

        /* Character model container */
        .character-container {
            position: absolute;
            bottom: 270px; /* Positioned to connect with text box */
            left: 50%;
            transform: translateX(-50%);
            width: 1700px;
            height: 750px; /* Made taller to fill the gap */
            z-index: 5;
        }

        .character-canvas {
            width: 100%;
            height: 100%;
            display: none;
        }

        .character-loading {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
            text-align: center;
            flex-direction: column;
            gap: 10px;
        }

        /* Text box container */
        .text-box {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 1200px;
            height: 250px; /* Increased from 180px to 250px */
            background: rgba(0, 0, 0, 0.95);
            border: 2px solid #333;
            border-radius: 8px;
            z-index: 10;
            padding: 20px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.7);
        }

        .character-name {
            color: #00ff00;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .dialogue-text {
            color: #ffffff;
            font-size: 14px;
            line-height: 1.6;
            flex: 1;
            overflow-y: auto;
            margin-bottom: 15px;
            padding-right: 10px;
        }

        .dialogue-text::-webkit-scrollbar {
            width: 6px;
        }

        .dialogue-text::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        .dialogue-text::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 3px;
        }

        .dialogue-text::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .message {
            margin-bottom: 15px;
            padding: 8px 0;
            position: relative;
        }

        .message.user {
            color: #ffff00;
        }

        .message.user::before {
            content: "> ";
            color: #00ff00;
        }

        .message.fairy {
            color: #ffffff;
            position: relative;
        }

        .voice-button {
            position: absolute;
            right: 10px;
            top: 8px;
            background: transparent;
            border: 1px solid #00ff00;
            color: #00ff00;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
            border-radius: 4px;
            font-family: 'Courier Prime', monospace;
            transition: all 0.3s ease;
        }

        .voice-button:hover:not(:disabled) {
            background: rgba(0, 255, 0, 0.1);
        }

        .voice-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .voice-button.playing {
            background: rgba(0, 255, 0, 0.2);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }

        .typing-indicator {
            color: #00ff00;
            font-style: italic;
            margin-bottom: 15px;
            padding: 8px 0;
        }

        .typing-dots {
            display: inline-block;
            animation: typingDots 1.5s infinite;
        }

        @keyframes typingDots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        .reaction-buttons {
            position: absolute;
            right: 50px;
            top: 8px;
            display: flex;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .message.fairy:hover .reaction-buttons {
            opacity: 1;
        }

        .reaction-btn {
            background: transparent;
            border: 1px solid #333;
            color: #fff;
            padding: 2px 6px;
            font-size: 12px;
            cursor: pointer;
            border-radius: 3px;
            transition: all 0.3s ease;
        }

        .reaction-btn:hover {
            background: rgba(0, 255, 0, 0.1);
            border-color: #00ff00;
        }

        .user-reactions {
            margin-top: 5px;
            font-size: 12px;
            color: #888;
        }

        .reaction-count {
            display: inline-block;
            margin-right: 10px;
            padding: 2px 6px;
            background: rgba(0, 255, 0, 0.1);
            border-radius: 3px;
            border: 1px solid #333;
        }

        .input-container {
            display: flex;
            align-items: center;
            gap: 10px;
            border-top: 1px solid #333;
            padding-top: 15px;
        }

        .input-prompt {
            color: #00ff00;
            font-size: 14px;
            white-space: nowrap;
        }

        .message-input {
            flex: 1;
            background: transparent;
            border: none;
            color: #ffffff;
            font-family: 'Courier Prime', monospace;
            font-size: 14px;
            outline: none;
            padding: 2px;
            border-bottom: 1px solid #333;
        }

        .message-input:focus {
            border-bottom-color: #00ff00;
        }

        .mic-button {
            background: transparent;
            border: 1px solid #333;
            color: #00ff00;
            padding: 6px 10px;
            font-family: 'Courier Prime', monospace;
            font-size: 16px;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.3s ease;
            min-width: 40px;
        }

        .mic-button:hover:not(:disabled) {
            background: rgba(0, 255, 0, 0.1);
            border-color: #00ff00;
        }

        .mic-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .mic-button.recording {
            background: rgba(255, 0, 0, 0.2);
            border-color: #ff0000;
            color: #ff0000;
            animation: pulse 1s infinite;
        }

        .mic-button.processing {
            background: rgba(255, 255, 0, 0.2);
            border-color: #ffff00;
            color: #ffff00;
        }

        .send-button {
            background: transparent;
            border: 1px solid #333;
            color: #00ff00;
            padding: 6px 12px;
            font-family: 'Courier Prime', monospace;
            font-size: 12px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
        }

        .send-button:hover:not(:disabled) {
            background: rgba(0, 255, 0, 0.1);
            border-color: #00ff00;
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .loading-dots {
            display: inline-block;
        }

        .loading-dots::after {
            content: '';
            animation: dots 1.5s infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .character-container {
                width: 400px;
                height: 500px;
                bottom: 230px;
            }

            .text-box {
                width: 95%;
                max-width: none;
                height: 200px;
                padding: 15px;
                bottom: 10px;
            }

            .social-icon {
                width: 60px;
                height: 60px;
                font-size: 10px;
            }

            .social-icons {
                top: 10px;
            }

            .social-icons.left {
                left: 10px;
            }

            .social-icons.right {
                right: 10px;
            }

            .dialogue-text {
                font-size: 13px;
            }

            .message-input {
                font-size: 13px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <img src="https://cdn.prod.website-files.com/6740d85c4e3daeef29a89470/6887e1da56935b68a476dc1c_BONKARA-28-07-2025.gif" 
             alt="Bonkara" class="bonkara-logo">
        
        <img src="https://cdn.prod.website-files.com/6740d85c4e3daeef29a89470/6887e196a6ca43c1525219f5_ChatGPT%20Image%20Jul%2028%2C%202025%2C%2009_46_08%20PM.png" 
             alt="Bonkara Portrait" class="floating-image">
        
        <button class="enter-button" onclick="enterSite()">
            Enter at Your Own Risk
        </button>
    </div>

    <!-- Main Content -->
    <div id="mainContent" class="main-content">
        <!-- Background -->
        <div class="background"></div>

        <!-- Social Media Icons -->
        <div class="social-icons left">
            <div class="social-icon twitter" onclick="window.open('https://twitter.com', '_blank')">
            </div>
            <div class="social-icon bonk" onclick="window.open('#', '_blank')">
            </div>
            <div class="social-icon onlyfans" onclick="window.open('https://onlyfans.com', '_blank')">
            </div>
        </div>

        <div class="social-icons right">
        </div>

        <!-- Character Model -->
        <div class="character-container">
            <canvas id="characterCanvas" class="character-canvas"></canvas>
            <div id="characterLoading" class="character-loading">
                <div>Loading Bonkara...</div>
                <div class="loading-dots"></div>
            </div>
        </div>

        <!-- Text Box -->
        <div class="text-box">
            <div class="character-name">Bonkara</div>
            <div class="dialogue-text" id="dialogueText">
                <div class="message fairy">
                    Welcome to my magical realm! I'm Bonkara, and I've been waiting for someone like you to visit. 
                    The forest spirits whisper that you have questions burning in your heart. What brings you to my domain today?
                </div>
            </div>
            <div class="input-container">
                <span class="input-prompt">></span>
                <input type="text" class="message-input" id="messageInput" placeholder="Type your message..." maxlength="500">
                <button class="mic-button" id="micButton" onclick="toggleSpeechRecognition()" title="Click to speak">🎤</button>
                <button class="send-button" id="sendButton" onclick="sendMessage()">Send</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let scene, camera, renderer, fairy, mixer;
        let audioAutoPlay = false;
        let backgroundMusic = null;
        let messageReactions = new Map(); // Store reactions for each message
        let messageCounter = 0; // Unique ID for each message
        let speechRecognition = null;
        let isRecording = false;
        const canvas = document.getElementById('characterCanvas');
        const loadingDiv = document.getElementById('characterLoading');
        const dialogueText = document.getElementById('dialogueText');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const micButton = document.getElementById('micButton');

        // Sound effects
        const soundEffects = {
            messageSend: null,
            messageReceived: null,
            reaction: null
        };

        // Initialize sound effects
        function initSoundEffects() {
            // Using free sound URLs - you can replace with your own hosted sounds
            soundEffects.messageSend = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmESBjuR2O/TeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmESBjuR2O/TeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmESBjuR2O/TeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmESBjuR2O/TeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmESBjuR2O/TeSsFJHfH8N2QQAoUXrTp66hVFA==');
            soundEffects.messageReceived = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmESBjuR2O/TeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmESBjuR2O/TeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmESBjuR2O/TeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmESBjuR2O/TeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmESBjuR2O/TeSsFJHfH8N2QQAoUXrTp66hVFA==');
            soundEffects.reaction = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmESBjuR2O/TeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmESBjuR2O/TeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmESBjuR2O/TeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmESBjuR2O/TeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmESBjuR2O/TeSsFJHfH8N2QQAoUXrTp66hVFA==');
            
            // Set volume for sound effects
            Object.values(soundEffects).forEach(sound => {
                if (sound) sound.volume = 0.3;
            });
        }

        function playSound(soundName) {
            if (soundEffects[soundName]) {
                soundEffects[soundName].currentTime = 0;
                soundEffects[soundName].play().catch(e => console.log('Sound play failed:', e));
            }
        }

        // Enter site function
        function enterSite() {
            audioAutoPlay = true;
            
            const loadingScreen = document.getElementById('loadingScreen');
            const mainContent = document.getElementById('mainContent');
            
            loadingScreen.classList.add('hidden');
            mainContent.classList.add('visible');
            
            // Start background music
            startBackgroundMusic();
            
            // Initialize sound effects
            initSoundEffects();
            
            // Initialize speech recognition
            initSpeechRecognition();
            
            // Start loading model immediately instead of waiting
            initThreeJS();
        }

        // Speech recognition setup
        function initSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                speechRecognition = new SpeechRecognition();
                
                speechRecognition.continuous = false;
                speechRecognition.interimResults = false;
                speechRecognition.lang = 'en-US';
                
                speechRecognition.onstart = function() {
                    isRecording = true;
                    micButton.className = 'mic-button recording';
                    micButton.textContent = '🔴';
                    console.log('Speech recognition started');
                };
                
                speechRecognition.onresult = function(event) {
                    const transcript = event.results[0][0].transcript;
                    messageInput.value = transcript;
                    console.log('Speech recognized:', transcript);
                };
                
                speechRecognition.onerror = function(event) {
                    console.error('Speech recognition error:', event.error);
                    resetMicButton();
                };
                
                speechRecognition.onend = function() {
                    resetMicButton();
                    // Auto-send the message if we got text
                    if (messageInput.value.trim()) {
                        sendMessage();
                    }
                };
            } else {
                // Hide mic button if not supported
                micButton.style.display = 'none';
                console.log('Speech recognition not supported');
            }
        }

        function toggleSpeechRecognition() {
            if (!speechRecognition) return;
            
            if (isRecording) {
                speechRecognition.stop();
            } else {
                speechRecognition.start();
            }
        }

        function resetMicButton() {
            isRecording = false;
            micButton.className = 'mic-button';
            micButton.textContent = '🎤';
        }

        // Background music function
        function startBackgroundMusic() {
            try {
                // Load background music from your GitHub repo
                backgroundMusic = new Audio('https://cdn.jsdelivr.net/gh/bartoai/fairy@main/background-music.mp3');
                backgroundMusic.loop = true;
                backgroundMusic.volume = 0.1; // Quieter volume (10%)
                
                // Try to play the background music
                backgroundMusic.play().catch(error => {
                    console.log('Background music autoplay blocked:', error);
                    // Fallback: show a small play button for background music
                    createMusicToggle();
                });
            } catch (error) {
                console.log('Background music failed to load:', error);
            }
        }

        // Create music toggle button if autoplay fails
        function createMusicToggle() {
            const musicButton = document.createElement('button');
            musicButton.innerHTML = '🎵';
            musicButton.style.cssText = `
                position: fixed;
                top: 20px;
                right: 120px;
                z-index: 15;
                background: rgba(0, 0, 0, 0.8);
                border: 1px solid #00ff00;
                color: #00ff00;
                padding: 8px 12px;
                border-radius: 5px;
                cursor: pointer;
                font-size: 16px;
            `;
            
            let musicPlaying = false;
            musicButton.onclick = () => {
                if (!musicPlaying) {
                    backgroundMusic.play();
                    musicButton.innerHTML = '🔇';
                    musicPlaying = true;
                } else {
                    backgroundMusic.pause();
                    musicButton.innerHTML = '🎵';
                    musicPlaying = false;
                }
            };
            
            document.body.appendChild(musicButton);
        }

        // Three.js setup
        function initThreeJS() {
            scene = new THREE.Scene();

            // Get the actual container dimensions
            const container = document.querySelector('.character-container');
            const containerWidth = container.clientWidth;
            const containerHeight = container.clientHeight;

            camera = new THREE.PerspectiveCamera(45, containerWidth / containerHeight, 0.1, 1000);
            camera.position.set(0, 1.5, 2.2);
            camera.lookAt(0, 1.2, 0);

            renderer = new THREE.WebGLRenderer({ 
                canvas: canvas, 
                antialias: true, 
                alpha: true 
            });
            
            // Force proper sizing
            renderer.setSize(containerWidth, containerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;

            const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
            scene.add(ambientLight);

            const keyLight = new THREE.DirectionalLight(0xffffff, 1.2);
            keyLight.position.set(2, 3, 2);
            keyLight.castShadow = true;
            scene.add(keyLight);

            const fillLight = new THREE.DirectionalLight(0xa8c8ff, 0.6);
            fillLight.position.set(-2, 1, 1);
            scene.add(fillLight);

            // Force a resize to ensure proper canvas sizing
            setTimeout(() => {
                onWindowResize();
            }, 100);

            loadFairyModel();
        }

        function loadFairyModel() {
            const loader = new THREE.GLTFLoader();
            const modelUrl = 'https://cdn.jsdelivr.net/gh/bartoai/fairy@main/fairywoman.glb';
            
            // Pre-configure loading manager for better performance
            const manager = new THREE.LoadingManager();
            loader.manager = manager;
            
            loader.load(
                modelUrl,
                function(gltf) {
                    fairy = gltf.scene;
                    
                    fairy.scale.set(2.0, 2.0, 2.0);
                    fairy.position.set(0, -2.7, 0);
                    
                    // Optimize model performance
                    fairy.traverse(function(child) {
                        if (child.isMesh) {
                            child.castShadow = true;
                            child.receiveShadow = true;
                            // Optimize materials for faster rendering
                            if (child.material) {
                                child.material.needsUpdate = true;
                            }
                        }
                    });
                    
                    scene.add(fairy);
                    
                    loadingDiv.style.display = 'none';
                    canvas.style.display = 'block';
                    
                    // Force canvas to show and resize properly
                    setTimeout(() => {
                        onWindowResize();
                        renderer.render(scene, camera);
                    }, 50);
                    
                    if (gltf.animations && gltf.animations.length > 0) {
                        mixer = new THREE.AnimationMixer(fairy);
                        const action = mixer.clipAction(gltf.animations[0]);
                        action.play();
                    }
                    
                    animate();
                },
                function(progress) {
                    // Update loading percentage for better user feedback
                    const percent = Math.round((progress.loaded / progress.total) * 100);
                    loadingDiv.innerHTML = `
                        <div>Loading Bonkara... ${percent}%</div>
                        <div class="loading-dots"></div>
                    `;
                },
                function(error) {
                    console.error('Error loading model:', error);
                    loadingDiv.innerHTML = `
                        <div>Failed to load model</div>
                        <div style="font-size: 12px; margin-top: 5px;">
                            Check connection and try refreshing
                        </div>
                    `;
                }
            );
        }

        function animate() {
            requestAnimationFrame(animate);
            
            if (mixer) {
                mixer.update(0.008);
            }
            
            if (fairy && !mixer) {
                fairy.position.y = Math.sin(Date.now() * 0.001) * 0.02;
            }
            
            renderer.render(scene, camera);
        }

        function onWindowResize() {
            const container = canvas.parentElement;
            const containerWidth = container.clientWidth;
            const containerHeight = container.clientHeight;
            
            // Update camera aspect ratio
            camera.aspect = containerWidth / containerHeight;
            camera.updateProjectionMatrix();
            
            // Update renderer size
            renderer.setSize(containerWidth, containerHeight);
            
            // Force a render
            if (scene && camera) {
                renderer.render(scene, camera);
            }
        }

        window.addEventListener('resize', onWindowResize);

        // Chat functionality
        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;

            // Play send sound effect
            playSound('messageSend');

            addMessage(message, 'user');
            messageInput.value = '';
            sendButton.disabled = true;
            sendButton.innerHTML = 'Sending<span class="loading-dots"></span>';

            // Show typing indicator
            showTypingIndicator();

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        character: 'bonkara'
                    })
                });

                if (!response.ok) {
                    throw new Error('API request failed');
                }

                const data = await response.json();
                
                // Hide typing indicator and add response
                hideTypingIndicator();
                addMessage(data.response, 'fairy');
                
                // Play received sound effect
                playSound('messageReceived');
            } catch (error) {
                console.error('API Error:', error);
                const fallbackResponses = [
                    "How fascinating! The ancient trees have been whispering about visitors like you. There's something special about your energy that draws the forest spirits near.",
                    "That question carries the scent of adventure! In my realm, such thoughts bloom into magical possibilities. I can sense great potential within you.",
                    "Oh my! You remind me of the wise spirits who dwell beyond the crystal caves. Your curiosity sparkles brighter than starlight.",
                    "The moonlight reveals that you seek something deeper than words can express. I can feel the longing in your heart, dear visitor.",
                    "Your energy resonates with the harmony of the enchanted grove. Tell me more about what brings you to my mystical domain, wanderer."
                ];
                
                const randomResponse = fallbackResponses[Math.floor(Math.random() * fallbackResponses.length)];
                hideTypingIndicator();
                addMessage(randomResponse, 'fairy');
                playSound('messageReceived');
            }

            sendButton.disabled = false;
            sendButton.innerHTML = 'Send';
        }

        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing-indicator';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = 'Bonkara is typing<span class="typing-dots">...</span>';
            dialogueText.appendChild(typingDiv);
            dialogueText.scrollTop = dialogueText.scrollHeight;
        }

        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        function addMessage(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            const messageId = ++messageCounter;
            messageDiv.dataset.messageId = messageId;
            
            if (sender === 'fairy') {
                const voiceButton = document.createElement('button');
                voiceButton.className = 'voice-button';
                voiceButton.textContent = '🔊';
                voiceButton.onclick = () => playVoice(text, voiceButton);
                messageDiv.appendChild(voiceButton);
                
                // Add reaction buttons
                const reactionContainer = document.createElement('div');
                reactionContainer.className = 'reaction-buttons';
                
                const reactions = ['❤️', '😍', '🔥', '😱', '😂'];
                reactions.forEach(emoji => {
                    const reactionBtn = document.createElement('button');
                    reactionBtn.className = 'reaction-btn';
                    reactionBtn.textContent = emoji;
                    reactionBtn.onclick = () => addReaction(messageId, emoji);
                    reactionContainer.appendChild(reactionBtn);
                });
                
                messageDiv.appendChild(reactionContainer);
                
                // Add reactions display area
                const reactionsDisplay = document.createElement('div');
                reactionsDisplay.className = 'user-reactions';
                reactionsDisplay.id = `reactions-${messageId}`;
                messageDiv.appendChild(reactionsDisplay);
                
                dialogueText.appendChild(messageDiv);
                
                // If auto-play is enabled, prepare audio first then type
                if (audioAutoPlay) {
                    prepareAndPlayTogether(messageDiv, text);
                } else {
                    // If no auto-play, just type normally
                    typeMessage(messageDiv, text);
                }
            } else {
                messageDiv.textContent = text;
                dialogueText.appendChild(messageDiv);
            }
            
            dialogueText.scrollTop = dialogueText.scrollHeight;
        }

        function addReaction(messageId, emoji) {
            // Play reaction sound
            playSound('reaction');
            
            // Initialize reactions for this message if not exists
            if (!messageReactions.has(messageId)) {
                messageReactions.set(messageId, new Map());
            }
            
            const messageReactionMap = messageReactions.get(messageId);
            const currentCount = messageReactionMap.get(emoji) || 0;
            messageReactionMap.set(emoji, currentCount + 1);
            
            // Update display
            updateReactionsDisplay(messageId);
        }

        function updateReactionsDisplay(messageId) {
            const reactionsDisplay = document.getElementById(`reactions-${messageId}`);
            const messageReactionMap = messageReactions.get(messageId);
            
            if (!reactionsDisplay || !messageReactionMap) return;
            
            let html = '';
            messageReactionMap.forEach((count, emoji) => {
                if (count > 0) {
                    html += `<span class="reaction-count">${emoji} ${count}</span>`;
                }
            });
            
            reactionsDisplay.innerHTML = html;
        }

        async function prepareAndPlayTogether(element, text) {
            try {
                // Show loading indicator while preparing audio
                element.textContent = '...';
                
                // Prepare the audio first
                const response = await fetch('/api/tts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ text: text })
                });

                if (response.ok) {
                    const data = await response.json();
                    const audio = new Audio();
                    audio.src = `data:audio/mpeg;base64,${data.audio}`;
                    
                    // Once audio is ready, start typing and playing together
                    audio.play().catch(e => console.log('Auto-play failed:', e));
                    typeMessage(element, text);
                } else {
                    // If audio fails, just type normally
                    typeMessage(element, text);
                }
            } catch (error) {
                console.log('Audio preparation failed:', error);
                // If audio fails, just type normally
                typeMessage(element, text);
            }
        }

        function typeMessage(element, text, callback, speed = 30) {
            let i = 0;
            element.textContent = '';
            
            function typeChar() {
                if (i < text.length) {
                    element.textContent += text.charAt(i);
                    i++;
                    dialogueText.scrollTop = dialogueText.scrollHeight;
                    setTimeout(typeChar, speed);
                } else if (callback) {
                    callback();
                }
            }
            
            typeChar();
        }

        async function playVoice(text, button) {
            if (button.disabled) return;
            
            button.disabled = true;
            button.classList.add('playing');
            button.textContent = '⏸️';
            
            try {
                const response = await fetch('/api/tts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ text: text })
                });

                if (!response.ok) {
                    throw new Error('TTS request failed');
                }

                const data = await response.json();
                
                const audio = new Audio();
                audio.src = `data:audio/mpeg;base64,${data.audio}`;
                
                audio.onended = () => {
                    button.disabled = false;
                    button.classList.remove('playing');
                    button.textContent = '🔊';
                };
                
                audio.onerror = () => {
                    button.disabled = false;
                    button.classList.remove('playing');
                    button.textContent = '🔊';
                    console.error('Audio playback failed');
                };
                
                await audio.play();
                
            } catch (error) {
                console.error('Voice generation failed:', error);
                button.disabled = false;
                button.classList.remove('playing');
                button.textContent = '🔊';
            }
        }
    </script>
</body>
</html>
